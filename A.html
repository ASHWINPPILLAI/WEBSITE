<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Bus Tracker (Real-time)</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase JS SDK -->
<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getAuth, 
    signInAnonymously, 
    onAuthStateChanged,
    signInWithCustomToken // Keep this import just in case, but we won't use it
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    onSnapshot, 
    setDoc,
    updateDoc,
    collection,
    query,
    where,
    getDocs,
    writeBatch,
    setLogLevel
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

  // --- Firebase Config and Initialization ---
  
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBvnvizMIsTb2Ydw7Wg-94eYEdXqJHpaJA",
    authDomain: "smart-bus-tracker-1fd61.firebaseapp.com",
    projectId: "smart-bus-tracker-1fd61",
    storageBucket: "smart-bus-tracker-1fd61.firebasestorage.app",
    messagingSenderId: "926506009709",
    appId: "1:926506009709:web:256842499201de729c2b64",
    measurementId: "G-NBTFVQPJK2"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app); // Initialize Analytics
  const auth = getAuth(app);
  const db = getFirestore(app);
  setLogLevel('debug');
  
  // ***
  // *** IMPORTANT FIX FOR "Missing or insufficient permissions" ERROR ***
  //
  // 1. The `appId` from firebaseConfig (e.g., "1:...") contains colons (:)
  //    which are invalid for Firestore paths. We must use a simple, static string.
  //
  const appId = "smart-bus-tracker-demo"; // Use a simple, static ID
  
  // 2. This error also means your Firestore Security Rules are blocking the app.
  //    To fix this for the demo, you MUST make your rules public:
  //
  //    a. Go to your Firebase Project Console.
  //    b. Go to Build > Firestore Database.
  //    c. Click the "Rules" tab.
  //    d. Replace ALL text in the editor with the following:
  //
  //    rules_version = '2';
  //    service cloud.firestore {
  //      match /databases/{database}/documents {
  //        // Allow public read/write access for this demo
  //        match /{document=**} {
  //          allow read, write: if true;
  //        }
  //      }
  //    }
  //
  //    e. Click "Publish".
  //    f. Refresh your app. The errors will be gone.
  // ***
  // ***

  // Simple polyfill if crypto.randomUUID is not available
  if (typeof crypto === 'undefined' || !crypto.randomUUID) {
    crypto.randomUUID = () => {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    };
  }

  // --- Firestore Paths ---
  // Use the new, clean appId for the path
  const publicDataPath = `artifacts/${appId}/public/data`;
  const busStatesCollectionPath = `${publicDataPath}/bus_live_states`;

  // --- Static Data ---
  const BUS_DATA = [
    { id:1, name:"Bus A1 (Gandhipuram)", routeStops:[ {name:"Gandhipuram", lat:11.0183, lng:76.9686},{name:"Ukkadam",lat:10.9915,lng:76.9669}], geofence: [[10.98, 76.95], [11.03, 76.95], [11.03, 76.98], [10.98, 76.98]] },
    { id:2, name:"Bus C1 (RS Puram)", routeStops:[ {name:"RS Puram",lat:11.0056,lng:76.9568},{name:"Gandhipuram",lat:11.0183,lng:76.9686}], geofence: [[10.99, 76.94], [11.03, 76.94], [11.03, 76.98], [10.99, 76.98]] },
    { id:3, name:"Bus D1 (Saibaba Kovil)", routeStops:[ {name:"Saibaba Kovil",lat:11.0260,lng:76.9515},{name:"Town Hall",lat:10.9971,lng:76.9689}], geofence: [[10.98, 76.94], [11.04, 76.94], [11.04, 76.98], [10.98, 76.98]] }
  ];

  // --- Global State ---
  let role = "";
  let userId = null;
  let mapInitialized = false;
  let map;
  let busIcon, sosIcon, deviatedIcon;

  // Live data from Firestore
  let busStates = {}; // e.g., { "1": { lat: ..., lng: ..., occupiedSeats: ... }, "2": ... }
  let simulationInterval = null; // To store the simulation interval ID

  // Map layers
  let currentBusStatic = null; // The selected bus's static data from BUS_DATA
  let currentMarker = null;
  let currentGeofenceLayer = null;
  let currentPolylineLayer = null;

  // --- DOM Elements ---
  // We use a helper to ensure DOM is loaded before assigning
  let loginErrorEl, occupiedEl, availableEl, seatProgEl, crowdLevelEl, wheelchairStatusEl,
      adminAlertsDiv, busSelector, sosMessageEl, searchRouteButton, startStopInput,
      endStopInput, searchErrorEl, seatsPanel, wheelchairPanel;

  function assignDOMElements() {
    loginErrorEl = document.getElementById('loginError');
    occupiedEl = document.getElementById('occupiedSeats');
    availableEl = document.getElementById('availableSeats');
    seatProgEl = document.getElementById('seatProgress');
    crowdLevelEl = document.getElementById('crowdLevel');
    wheelchairStatusEl = document.getElementById('wheelchairStatus');
    adminAlertsDiv = document.getElementById("adminAlerts");
    busSelector = document.getElementById("busSelector");
    sosMessageEl = document.getElementById('sosMessage');
    searchRouteButton = document.getElementById('searchRouteButton');
    startStopInput = document.getElementById('startStop');
    endStopInput = document.getElementById('endStop');
    searchErrorEl = document.getElementById('searchError');
    seatsPanel = document.getElementById('seatsPanel');
    wheelchairPanel = document.getElementById('wheelchairPanel');
  }

  // --- Firestore Helper ---
  const initializeDatabase = async () => {
    console.log("Initializing database...");
    const batch = writeBatch(db);
    let hasData = false;

    const checkQuery = query(collection(db, busStatesCollectionPath), where("id", "==", 1));
    const querySnapshot = await getDocs(checkQuery);
    if (!querySnapshot.empty) {
      hasData = true;
    }

    if (!hasData) {
      console.log("No data found. Initializing Firestore...");
      BUS_DATA.forEach(bus => {
        const liveStateRef = doc(db, busStatesCollectionPath, bus.id.toString());
        batch.set(liveStateRef, {
          id: bus.id,
          lat: bus.routeStops[0].lat,
          lng: bus.routeStops[0].lng,
          isDeviated: false,
          sosActive: false,
          occupiedSeats: Math.floor(Math.random() * 15) + 5,
          wheelchairAvailable: Math.random() > 0.5,
        });
      });
      await batch.commit();
      console.log("Database initialized with default data.");
    } else {
      console.log("Database already initialized.");
    }
  };

  // --- Geofence Logic ---
  function isPointInPolygon(point, polygon) {
    let [lat, lng] = point;
    let isInside = false;
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
      let [pi_lat, pi_lng] = polygon[i];
      let [pj_lat, pj_lng] = polygon[j];
      let intersect = ((pi_lng > lng) !== (pj_lng > lng)) && (lat < (pj_lat - pi_lat) * (lng - pi_lng) / (pj_lng - pi_lng) + pi_lat);
      if (intersect) isInside = !isInside;
    }
    return isInside;
  }

  // --- Map Functions ---
  function initMap() {
    if (mapInitialized) return;
    map = L.map('busMap').setView([11.0168,76.9558], 11); // Center of Coimbatore
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);

    busIcon = L.divIcon({ html:'<div style="font-size:36px;">üöå</div>', className:'', iconSize:[60,60], iconAnchor:[30,30] });
    sosIcon = L.divIcon({ html:'<div style="font-size:36px; animation: pulse-red 1s infinite;">üö®</div>', className:'', iconSize:[60,60], iconAnchor:[30,30] });
    deviatedIcon = L.divIcon({ html:'<div style="font-size:36px;">‚ö†Ô∏è</div>', className:'', iconSize:[60,60], iconAnchor:[30,30] });
    
    mapInitialized = true;
    setTimeout(() => { if(map) map.invalidateSize(); }, 100);
  }

  function clearMap() {
    if (!mapInitialized) return;
    if(currentMarker) map.removeLayer(currentMarker);
    if(currentGeofenceLayer) map.removeLayer(currentGeofenceLayer);
    if(currentPolylineLayer) map.removeLayer(currentPolylineLayer);
    // currentBusStatic = null; // Don't null this, snapshot listener needs it
    currentMarker = null;
    currentGeofenceLayer = null;
    currentPolylineLayer = null;
  }

  function showSelectedBus(busStaticData) {
    if (!mapInitialized) return;
    clearMap(); 
    currentBusStatic = busStaticData;
    
    // Get the live data for this bus
    let liveState = busStates[busStaticData.id.toString()];
    
    // *** FIX: Use static data as a fallback if live data isn't ready ***
    if (!liveState) {
      console.warn("No live state for bus", busStaticData.id, ". Using static data for first draw.");
      liveState = {
          lat: busStaticData.routeStops[0].lat,
          lng: busStaticData.routeStops[0].lng,
          sosActive: false,
          isDeviated: false
      };
    }

    let icon = busIcon;
    if (liveState.sosActive) icon = sosIcon;
    else if (liveState.isDeviated) icon = deviatedIcon;
    
    currentMarker = L.marker([liveState.lat, liveState.lng], {icon:icon}).addTo(map).bindPopup(busStaticData.name);
    const latlngs = busStaticData.routeStops.map(stop => [stop.lat, stop.lng]);
    currentPolylineLayer = L.polyline(latlngs, {color:'blue', weight:3, dashArray:'5,10'}).addTo(map);
    currentGeofenceLayer = L.polygon(busStaticData.geofence, {color: '#ffc107', weight: 2, fillOpacity: 0.1}).addTo(map);
    
    map.fitBounds(currentGeofenceLayer.getBounds());
  }
  
  // --- *** FIXED UI Update Function *** ---
  
  function updateDashboardUI(busId) {
    // Ensure elements are ready
    if (!occupiedEl) assignDOMElements(); 
    
    const liveState = busId ? busStates[busId.toString()] : null;
    
    if (liveState) {
      // --- DATA IS LIVE ---
      document.getElementById('seats-placeholder').style.display = 'none';
      document.getElementById('wheelchair-placeholder').style.display = 'none';
      
      const TOTAL_SEATS = 30;
      const occupied = liveState.occupiedSeats;
      const available = TOTAL_SEATS - occupied;
      const pct = (occupied / TOTAL_SEATS) * 100;
      
      let crowdLevel, crowdColor;
      if (pct <= 50) { crowdLevel = 'Low'; crowdColor = 'green'; }
      else if (pct <= 80) { crowdLevel = 'Medium'; crowdColor = 'orange'; }
      else { crowdLevel = 'High'; crowdColor = 'red'; }
      
      occupiedEl.textContent = occupied;
      availableEl.textContent = available;
      seatProgEl.style.width = pct + '%';
      crowdLevelEl.textContent = crowdLevel;
      crowdLevelEl.style.color = crowdColor;
      seatsPanel.classList.remove('opacity-50');

      const isAvailable = liveState.wheelchairAvailable;
      wheelchairStatusEl.textContent = isAvailable ? 'Available' : 'Not Available';
      wheelchairStatusEl.style.color = isAvailable ? 'green' : 'red';
      wheelchairPanel.classList.remove('opacity-50');

    } else {
      // --- NO BUS SELECTED OR DATA IS NOT LOADED YET ---
      
      // Show placeholders
      document.getElementById('seats-placeholder').style.display = 'block';
      document.getElementById('wheelchair-placeholder').style.display = 'block';

      // Reset text to default
      occupiedEl.textContent = "--";
      availableEl.textContent = "--";
      seatProgEl.style.width = '0%';
      crowdLevelEl.textContent = "--";
      crowdLevelEl.style.color = 'black'; // Reset color
      wheelchairStatusEl.textContent = "--";
      wheelchairStatusEl.style.color = 'black'; // Reset color
      
      // Gray out panels
      seatsPanel.classList.add('opacity-50');
      wheelchairPanel.classList.add('opacity-50');
    }
  }


  function addAdminAlert(bus, type) {
    if (!adminAlertsDiv) assignDOMElements();
    if (adminAlertsDiv.querySelector("p")) adminAlertsDiv.innerHTML = "";
    const alert = document.createElement('div');
    const time = new Date().toLocaleTimeString();
    if (type === 'SOS') {
      alert.className = 'alert-card alert-sos';
      alert.innerHTML = `<strong>SOS!</strong> ${bus.name} triggered panic button at ${time}.`;
      adminAlertsDiv.prepend(alert);
      const policeAlert = document.createElement('div');
      policeAlert.className = 'alert-card alert-sos';
      policeAlert.innerHTML = `<strong>INFO:</strong> ${bus.name} route and details forwarded to nearest police station.`;
      adminAlertsDiv.prepend(policeAlert);
    } else if (type === 'DEVIATION') {
      alert.className = 'alert-card alert-deviation';
      alert.innerHTML = `<strong>DEVIATION!</strong> ${bus.name} went off-route at ${time}.`;
      adminAlertsDiv.prepend(alert);
    } else if (type === 'SAFE') {
      alert.className = 'alert-card alert-safe';
      alert.innerHTML = `<strong>SAFE:</strong> ${bus.name} is back on route at ${time}.`;
      adminAlertsDiv.prepend(alert);
    }
  }

  async function checkGeofence(bus, busState) {
    if (!bus || !busState || busState.sosActive) return; 

    const isInside = isPointInPolygon([busState.lat, busState.lng], bus.geofence);
    const busRef = doc(db, busStatesCollectionPath, bus.id.toString());

    if (!isInside && !busState.isDeviated) {
      await updateDoc(busRef, { isDeviated: true });
      addAdminAlert(bus, 'DEVIATION');
    } else if (isInside && busState.isDeviated) {
      await updateDoc(busRef, { isDeviated: false });
      addAdminAlert(bus, 'SAFE');
    }
  }

  // --- Real-time Simulation & Listeners ---
  
  function startBusSimulation() {
    if (simulationInterval) clearInterval(simulationInterval);
    
    simulationInterval = setInterval(async () => {
      if (!currentBusStatic || role !== 'pilot') return;

      const currentBusState = busStates[currentBusStatic.id.toString()];
      if (!currentBusState || currentBusState.isDeviated || currentBusState.sosActive) {
        return; // Don't move
      }

      let [startLat, startLng] = [currentBusState.lat, currentBusState.lng];
      let [endLat, endLng] = currentBusStatic.routeStops[1]
        ? [currentBusStatic.routeStops[1].lat, currentBusStatic.routeStops[1].lng]
        : [currentBusStatic.routeStops[0].lat, currentBusStatic.routeStops[0].lng];

      let newLat = startLat + (endLat - startLat) * 0.05;
      let newLng = startLng + (endLng - startLng) * 0.05;
      
      const latDist = Math.abs(newLat - endLat);
      const lngDist = Math.abs(newLng - endLng);

      // Reset if close to destination
      if (latDist < 0.0001 && lngDist < 0.0001) { 
        newLat = currentBusStatic.routeStops[0].lat;
        newLng = currentBusStatic.routeStops[0].lng;
      }
      
      const newState = { ...currentBusState, lat: newLat, lng: newLng };
      
      const busRef = doc(db, busStatesCollectionPath, currentBusStatic.id.toString());
      try {
        await updateDoc(busRef, { lat: newLat, lng: newLng });
        // Geofence check will be triggered by the snapshot listener
      } catch (error) {
        console.error("Error updating bus location: ", error);
      }
    }, 2000);
  }

  function startAppListeners() {
    // Listen for changes to ANY bus
    const q = query(collection(db, busStatesCollectionPath));
    onSnapshot(q, (querySnapshot) => {
      querySnapshot.forEach((doc) => {
        busStates[doc.id] = doc.data();
      });

      // If a bus is currently selected, update its UI
      if (currentBusStatic) {
        const liveState = busStates[currentBusStatic.id.toString()];
        
        if (liveState) {
          updateDashboardUI(currentBusStatic.id);
          
          // Update map marker if it exists
          if (currentMarker) {
            currentMarker.setLatLng([liveState.lat, liveState.lng]);
            
            let icon = busIcon;
            if (liveState.sosActive) icon = sosIcon;
            else if (liveState.isDeviated) icon = deviatedIcon;
            currentMarker.setIcon(icon);
            
            // Check geofence status
            checkGeofence(currentBusStatic, liveState);
          }
        }
      }
    }, (error) => {
      console.error("Error in bus_live_states snapshot listener: ", error);
    });
  }


  // --- Event Handlers ---
  
  // Login / Logout
  window.loginPilot = () => {
    if (!loginErrorEl) assignDOMElements(); // Ensure elements are ready
    const username=document.getElementById('username').value.trim();
    const password=document.getElementById('password').value.trim();
    if(username==="pilot" && password==="1234"){
      role="pilot";
      initializeDatabase(); 
      setupDashboard();
    } else {
      loginErrorEl.textContent = "Invalid credentials! (Hint: pilot/1234)";
    }
  }

  window.enterPassenger = () => {
    role="passenger";
    setupDashboard();
  }

  window.logout = () => {
    role="";
    document.getElementById('dashboard').style.display="none";
    document.getElementById('loginPage').style.display="block";
    document.getElementById('username').value = "";
    document.getElementById('password').value = "";
    loginErrorEl.textContent = "";
    
    clearMap();
    currentBusStatic = null;
    busSelector.value = ""; // Reset dropdown
    updateDashboardUI(null); // *** FIX: Reset panels to placeholder ***

    if (simulationInterval) clearInterval(simulationInterval);
    // Note: We don't sign out the anonymous user, they just go back to login
  }
  
  function setupDashboard() {
    if (!loginErrorEl) assignDOMElements();
    loginErrorEl.textContent = "";
    document.getElementById('loginPage').style.display="none";
    document.getElementById('dashboard').style.display="block";
    document.getElementById('roleTitle').textContent = role === 'pilot' ? "Pilot Dashboard" : "Passenger View";

    if (role === 'pilot') {
      document.getElementById('pilotControlsSeats').style.display="block";
      document.getElementById('wheelchairControls').style.display="block";
      document.getElementById('adminPanel').style.display="block";
      document.getElementById('trackingControls').style.display="block";
    } else {
      document.getElementById('pilotControlsSeats').style.display="none";
      document.getElementById('wheelchairControls').style.display="none";
      document.getElementById('adminPanel').style.display="none";
      document.getElementById('trackingControls').style.display="none";
    }
    
    initMap(); // Initialize the map
    
    // Set placeholder text
    updateDashboardUI(null);
  }

  // Route Search
  function setupRouteSearch() {
    searchRouteButton.onclick = () => {
      const start = startStopInput.value.trim().toLowerCase();
      const end = endStopInput.value.trim().toLowerCase();
      searchErrorEl.textContent = "";

      if (!start || !end) {
        searchErrorEl.textContent = "Please enter both a start and end stop.";
        return;
      }

      const foundBus = BUS_DATA.find(bus => {
        const stops = bus.routeStops.map(s => s.name.toLowerCase());
        const startIndex = stops.indexOf(start);
        const endIndex = stops.indexOf(end);
        return startIndex !== -1 && endIndex !== -1 && startIndex < endIndex;
      });

      if (foundBus) {
        busSelector.value = foundBus.id; // Update dropdown
        showSelectedBus(foundBus); // Update map
        updateDashboardUI(foundBus.id); // Update panels
        if (role === 'pilot') startBusSimulation(); // Start simulation if pilot
      } else {
        searchErrorEl.textContent = "No bus found for that route.";
        clearMap();
        updateDashboardUI(null); // Reset panels
      }
    };
  }

  // Bus Selector
  function setupBusSelector() {
    busSelector.onchange = () => {
      const selectedId = parseInt(busSelector.value);
      const bus = BUS_DATA.find(b => b.id === selectedId);
      if (bus) {
        showSelectedBus(bus);
        updateDashboardUI(bus.id);
        if (role === 'pilot') startBusSimulation();
      } else {
        clearMap();
        currentBusStatic = null;
        updateDashboardUI(null); // *** FIX: Reset panels to placeholder ***
        if (simulationInterval) clearInterval(simulationInterval);
      }
    };
  }

  // Pilot Controls
  function setupPilotControls() {
    document.getElementById('plusSeat').onclick = async () => {
      if (role !== "pilot" || !currentBusStatic) return;
      const currentSeats = busStates[currentBusStatic.id.toString()].occupiedSeats;
      const newSeats = Math.min(currentSeats + 1, 30);
      const busRef = doc(db, busStatesCollectionPath, currentBusStatic.id.toString());
      await updateDoc(busRef, { occupiedSeats: newSeats });
    };
    
    document.getElementById('minusSeat').onclick = async () => {
      if (role !== "pilot" || !currentBusStatic) return;
      const currentSeats = busStates[currentBusStatic.id.toString()].occupiedSeats;
      const newSeats = Math.max(currentSeats - 1, 0);
      const busRef = doc(db, busStatesCollectionPath, currentBusStatic.id.toString());
      await updateDoc(busRef, { occupiedSeats: newSeats });
    };

    document.getElementById('reserveWC').onclick = async () => {
      if (role !== "pilot" || !currentBusStatic) return;
      const busRef = doc(db, busStatesCollectionPath, currentBusStatic.id.toString());
      await updateDoc(busRef, { wheelchairAvailable: false });
    };
    
    document.getElementById('releaseWC').onclick = async () => {
      if (role !== "pilot" || !currentBusStatic) return;
      const busRef = doc(db, busStatesCollectionPath, currentBusStatic.id.toString());
      await updateDoc(busRef, { wheelchairAvailable: true });
    };

    document.getElementById('sosButton').onclick = async () => {
      if (role !== "pilot" || !currentBusStatic) return;
      const busRef = doc(db, busStatesCollectionPath, currentBusStatic.id.toString());
      await updateDoc(busRef, { sosActive: true });
      addAdminAlert(currentBusStatic, 'SOS');
      sosMessageEl.textContent = "SOS Activated! Authorities Notified.";
      setTimeout(() => { sosMessageEl.textContent = ""; }, 4000);
    };
    
    document.getElementById('forceDeviationButton').onclick = async () => {
      if (role !== "pilot" || !currentBusStatic) return;
      const newState = {
        lat: currentBusStatic.geofence[0][0] + 0.05,
        lng: currentBusStatic.geofence[0][1] + 0.05,
      };
      const busRef = doc(db, busStatesCollectionPath, currentBusStatic.id.toString());
      await updateDoc(busRef, newState);
      // Listener will pick up the change and check geofence
    };

    document.getElementById('returnRouteButton').onclick = async () => {
      if (role !== "pilot" || !currentBusStatic) return;
      const newState = {
        lat: currentBusStatic.routeStops[0].lat,
        lng: currentBusStatic.routeStops[0].lng,
        isDeviated: false,
        sosActive: false,
      };
      const busRef = doc(db, busStatesCollectionPath, currentBusStatic.id.toString());
      await updateDoc(busRef, newState);
      // Listener will pick up the change
    };
  }
  
  // --- App Initialization ---
  
  // Wait for DOM to be loaded before setting up handlers
  document.addEventListener("DOMContentLoaded", () => {
    // Assign all elements once
    assignDOMElements();
    
    // Add bus options to dropdown
    BUS_DATA.forEach(bus => {
      const option = document.createElement('option');
      option.value = bus.id;
      option.textContent = bus.name;
      busSelector.appendChild(option);
    });
    
    // Setup event handlers
    setupRouteSearch();
    setupBusSelector();
    setupPilotControls();

    // --- Firebase Auth ---
    // This is the simplified sign-in function for local use
    const signIn = async () => {
      try {
        await signInAnonymously(auth);
        console.log("Signed in anonymously.");
      } catch (error) {
        console.error("Firebase sign-in error:", error);
      }
    };
    
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid || crypto.randomUUID();
        console.log("User is signed in with UID:", userId);
        // Now that we are signed in, start listening to data
        startAppListeners();
        // NOTE: initializeDatabase() is now called on pilot login
      } else {
        userId = null;
        console.log("User is signed out.");
      }
    });
    
    // Start the sign-in process
    signIn();

  });

</script>

<style>
body {font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#e0f2fe,#fef9c3);margin:0;}
header{background:#1e3a8a;color:#fff;padding:15px;text-align:center;font-weight:bold;font-size:20px;}
.container{max-width:720px;margin:20px auto;padding:15px;}
h2{text-align:center;color:#1e3a8a;margin-bottom:15px;}
h3{color:#1e3a8a;}
.panel{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 6px 15px rgba(0,0,0,0.08);}
button{padding:8px 14px;margin:6px 4px;cursor:pointer;border:none;border-radius:6px;font-weight:600;}
.btn-green{background:#16a34a;color:#fff}.btn-green:hover{background:#15803d;}
.btn-red{background:#dc2626;color:#fff}.btn-red:hover{background:#b91c1c;}
.btn-blue{background:#2563eb;color:#fff}.btn-blue:hover{background:#1d4ed8;}
input, select{padding:10px;width:100%;margin:6px 0;border:1px solid #ccc;border-radius:6px;font-size:14px; box-sizing: border-box;}
.progress-bar{background:#e5e7eb;border-radius:6px;overflow:hidden;height:18px;margin-top:5px;}
.progress{height:100%;background:#34d399;transition:width 0.3s;}
#crowdLevel{font-weight:bold;}
.offline{color:#9a3412;font-weight:bold;}
footer{text-align:center;font-size:13px;color:#555;margin:20px 0;}
#busMap{width:100%; height:400px; border-radius:12px; margin-top:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
#loginError { color: #b91c1c; font-weight: bold; margin-top: 10px; text-align: center; }
#searchError { color: #b91c1c; font-weight: 500; margin-top: 5px; }
.opacity-50 { opacity: 0.5; cursor: not-allowed; }
.placeholder { color: #777; font-style: italic; }
/* Hide placeholders by default, show them via JS */
#seats-placeholder, #wheelchair-placeholder { display: none; }

/* --- STYLES for DEMO & TRACKING --- */
#adminAlerts { background: #e9ecef; padding: 10px; border-radius: 5px; margin-top: 10px; min-height: 150px; }
.alert-card { padding: 8px; border-radius: 5px; margin-bottom: 8px; color: white; transition: all 0.3s ease; }
.alert-sos { background-color: #dc3545; border-left: 5px solid #a71d2a; animation: pulse-red 1s infinite; }
.alert-deviation { background-color: #ffc107; color: black; border-left: 5px solid #c69500; }
.alert-safe { background-color: #28a745; border-left: 5px solid #1e7e34; }

#trackingControls button { margin: 5px 0; width: 100%; }
#sosButton { background-color: #dc3545; color: white; }
#sosButton:hover { background-color: #c82333; }
#forceDeviationButton { background-color: #ffc107; color: black;}
#returnRouteButton { background-color: #28a745; color: white; }
#sosMessage { color: #dc3545; font-weight: bold; text-align: center; margin-top: 10px; }
.leaflet-div-icon { background: transparent; border: none; }

@keyframes pulse-red {
¬† 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
¬† 70% { transform: scale(1.02); box-shadow: 0 0 10px 10px rgba(220, 53, 69, 0); }
¬† 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}
</style>
</head>
<body>

<header>üöç Smart Bus Tracker</header>

<!-- Login Page -->
<div class="container" id="loginPage">
¬† <h2>Welcome</h2>
¬† <div class="panel">
¬† ¬† <h3>Pilot Login</h3>
¬† ¬† <input type="text" id="username" placeholder="Username">
¬† ¬† <input type="password" id="password" placeholder="Password">
¬† ¬† <button class="btn-green" onclick="loginPilot()">Login as Pilot</button>
¬† </div>
¬† <div class="panel">
¬† ¬† <h3>Passenger Access</h3>
¬† ¬† <button class="btn-blue" onclick="enterPassenger()">Enter as Passenger</button>
¬† </div>
  <div id="loginError"></div>
</div>

<!-- Dashboard -->
<div class="container" id="dashboard" style="display:none;">
¬† <h2 id="roleTitle"></h2>

¬† <!-- Route Search -->
¬† <div class="panel">
¬† ¬† <h3>Search Bus by Route</h3>
    <div id="searchError"></div>
¬† ¬† <input type="text" id="startStop" placeholder="Enter Start Stop (e.g., Gandhipuram)">
¬† ¬† <input type="text" id="endStop" placeholder="Enter End Stop (e.g., Ukkadam)">
¬† ¬† <button class="btn-green" id="searchRouteButton">Search Route</button>
¬† </div>

¬† <!-- Seats -->
¬† <div class="panel" id="seatsPanel">
¬† ¬† <h3>Seats / Crowd Level</h3>
    <p id="seats-placeholder" class="placeholder" style="display: block;">Please select a bus to view seat info.</p>
¬† ¬† <p>Total Seats: <span id="totalSeats">30</span></p>
¬† ¬† <p>Occupied: <span id="occupiedSeats">--</span></p>
¬† ¬† <p>Available: <span id="availableSeats">--</span></p>
¬† ¬† <div class="progress-bar"><div class="progress" id="seatProgress" style="width:0%"></div></div>
¬† ¬† <p>Crowd Level: <span id="crowdLevel">--</span></p>
¬† ¬† <div id="pilotControlsSeats" style="display:none;">
¬† ¬† ¬† <button id="plusSeat" class="btn-green">+</button>
¬† ¬† ¬† <button id="minusSeat" class="btn-red">-</button>
¬† ¬† </div>
¬† </div>

¬† <!-- Wheelchair -->
¬† <div class="panel" id="wheelchairPanel">
¬† ¬† <h3>Wheelchair Accessibility</h3>
    <p id="wheelchair-placeholder" class="placeholder" style="display: block;">Please select a bus to view accessibility.</p>
¬† ¬† <p>Wheelchair Space: <span id="wheelchairStatus">--</span></p>
¬† ¬† <div id="wheelchairControls" style="display:none;">
¬† ¬† ¬† <button id="reserveWC" class="btn-green">Reserve Wheelchair</button>
¬† ¬† ¬† <button id="releaseWC" class="btn-red">Release Wheelchair</button>
¬† ¬† </div>
¬† </div>

¬† <!-- Live Map -->
¬† <div class="panel">
¬† ¬† <h3>Live Tracking</h3>
¬† ¬† <label for="busSelector">Select a Bus to Track:</label>
S¬† ¬† <select id="busSelector">
¬† ¬† ¬† <option value="">-- Select Bus --</option>
¬† ¬† </select>
¬† ¬† <div id="busMap"></div>
¬† </div>
¬† 
¬† <!-- Tracking Controls (Pilot Only) -->
¬† <div class="panel" id="trackingControls" style="display:none;">
¬† ¬† <h3>Tracking Demo Controls</h3>
¬† ¬† <button id="sosButton">üö® TRIGGER SOS</button>
    <div id="sosMessage"></div>
¬† ¬† <button id="forceDeviationButton">‚ö†Ô∏è Force Route Deviation</button>
¬† ¬† <button id="returnRouteButton">‚úÖ Return to Route</button>
  </div>

  <!-- Admin Alerts (Pilot Only) -->
  <div class="panel" id="adminPanel" style="display:none;">
s¬† ¬† <h3>Admin Alerts</h3>
¬† ¬† <div id="adminAlerts"><p><i>Alerts will appear here...</i></p></div>
  </div>

¬† <button class="btn-red" onclick="logout()">Logout</button>
</div>

<footer>¬© 2025 Smart Bus Tracker | SIH Demo</footer>

</body>
</html>

